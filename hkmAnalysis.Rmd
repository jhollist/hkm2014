---
title: "Analysis for Hollister, Kreakie, Milstead"
author: "Jeff Hollister, Betty Kreakie, Bryan Milstead"
date: "Monday, April 28, 2014"
output: pdf_document
---

```{r setup, include=FALSE, echo=FALSE, cache=TRUE}
devtools::install_github("hkm","jhollist")
library(hkm)
library(varSelRF)
data(hkm2014Data)
```



## Main Question: Given that we have a unique combination of novel data, increased computational facilities, and an expanded geographic scope, what can we add to the classic understanding of the processes that are predictive of chlorophyll *a* and trophic state in lakes. 

### Initital variable selection (Jeff)
1.mean temp
2.DD45 
3.Select scale(s) - local - 300m and regional - 3000m
 *ANALYSIS*- as a check look at centroid distance matrix 
4.Turbidity, not secchi - because turb is an instrument measure and not limited by depth of lake.  If need be Turb could be converted to and estimated secchi.


```{r predictorSelection, echo=FALSE, cache=FALSE} 
	#select the predictor variable
		omit<-unique(c(grep("NLA_ID",names(hkm2014Data)),  #NLA_ID
						grep("Comid",names(hkm2014Data)),				 #Comid
						grep("NA_",names(hkm2014Data)),          #NA tabulations for Landscape variables
						grep("MaxDist",names(hkm2014Data)),      #MaxDist Buffer Variables
						grep("1500m",names(hkm2014Data)),        #1500m Buffer Variables
						grep("Km2",names(hkm2014Data)),					 #Buffer Variables tabulated as area
						grep("DDs",names(hkm2014Data))[-2],      #Degree Days variables-keep DDs45
						grep("Tm",names(hkm2014Data))[-3],       #Water Temp variables-keep TmeanW
						grep("SECMEAN",names(hkm2014Data))[-3],  #SECMEAN dropped-using TURB instead
						grep("CHLA",names(hkm2014Data))[-3],     #CHLA dropped; it is the response variable
						grep("TS_",names(hkm2014Data))))         #Trophic State Classification Variables
	Pvar<-hkm2014Data[,-omit]  #df with the predictor variables.
```

### Analysis 1. Compare classic linear models to random forest models?

1.Chl a ~ TP (converted to TS)
2.Chl a ~ TN (converted to TS)
3.Chl a ~ TN + TP (converted to TS)
4.Chl a ~ Linear Mod with varSelRF variables (converted to TS)

```{r linearModels, echo=FALSE, cache=FALSE} 
	#select complete cases
		keep<-complete.cases(Pvar,hkm2014Data$TS_CHLA)
	#run rf
		varSelAll<-varSelRF(Pvar[keep,],hkm2014Data[keep,'TS_CHLA'],ntree = 10000, 
												 ntreeIterat = 5000, vars.drop.frac = 0.2)
	#view results
		varSelAll  #Selected variables: "NTL"      "PTL"      "TOC"      "TURB"     "WSA_ECO9"
		summary(varSelAll$selec.history)
		plot(varSelAll, which=2)

	#select data for linear models
		Vars<-c('CHLA','NTL','PTL','TOC','TURB') #select vars for linear model
		LMdata<-log(hkm2014Data[,Vars]) #log transform data
			names(LMdata)<-paste('ln',Vars,sep='')

	#run linear models  
		Formula1 <- formula(paste(names(LMdata)[1],'~',paste(names(LMdata)[2], collapse="+"))) 
		Formula2 <- formula(paste(names(LMdata)[1],'~',paste(names(LMdata)[3], collapse="+"))) 
		Formula3 <- formula(paste(names(LMdata)[1],'~',paste(names(LMdata)[2:3], collapse="+"))) 
		Formula4 <- formula(paste(names(LMdata)[1],'~',paste(names(LMdata)[-1], collapse="+")))  

		summary(lm(Formula1,data=LMdata))  #adjR2==.5216
		summary(lm(Formula2,data=LMdata))  #adjR2==.5245
		summary(lm(Formula3,data=LMdata))  #adjR2==.5785
		summary(lm(Formula4,data=LMdata))  #adjR2==.6482
```


5.Chl a TS ~ RF(varSelRF variables) - single randomForest run
6.Chl a TS ~ Random Forest Consensus - single randomForest run

*ANALYSIS*
- varSelRF (Bryan plus play with varSelRFBoot)
- run linear models (1-4) (Bryan)
- run RF (Betty)
 - randomForest All Variables
 - randomForest varSelRF Variables
- output error matrices (Bryan, Betty and Jeff)
 - overall accuracy
 - Kappa


### Question 2. Are *in situ* nutrient and water quality data required to make predicitions of trophic state or can GIS derived information on lake and land use/land cover also provide quality predictions?

**Predict for these classes**
1. NLA Chl a trophic state classes
2. High/Low trophic state classes

### Question3. Can data-mining approaches identify new, interesting variables to use for the prediction of trophic state?



## Here's the analysis part:

### Initial Variable Culling:

This set of code creates namesets needed to cull out the initial set of variables

```{r variableSelection, echo=FALSE, cache=FALSE}
nlawqNames<-names(hkm2014Data)[c(155:158,160:194)]
nlawqNames<-nlawqNames[!nlawqNames%in%c("SECMEAN","TminW","TmaxW")]
gisNames<-names(hkm2014Data[c(3,149:153,195:208)])
gisNames<-gisNames[!gisNames%in%c("DD40","DD50")]
lulcPercentNames<-names(hkm2014Data[c(grep("PercentImperv",names(hkm2014Data)),grep("Per_",names(hkm2014Data)))])
if(length(grep("NA_",lulcPercentNames))>0){lulcPercentNames<-lulcPercentNames[-grep("NA_",lulcPercentNames)]}
lulcPercentNames<-lulcPercentNames[-grep("_1500m",lulcPercentNames)]
respName<-"TS_CHLA"
allVarDF<-na.omit(hkm2014Data[,c(nlawqNames,gisNames,lulcPercentNames,respName)])
```


## Chl *a* Trophic Status ~ All Variables + Landscape Percent

```{r allLandscapePercent, echo=FALSE, cache=FALSE, eval=FALSE}

allPerc_varsel<-varSelRF(allVarDF[,1:dim(allVarDF)[2]-1],allVarDF[,respName],ntree = 10000, 
												 ntreeIterat = 5000, vars.drop.frac = 0.2)
summary(allPerc_varsel$selec.history)
plot(allPerc_varsel, which=2)

```



## Chl *a* Trophic Status ~ GIS Only Variables +Landscape Percent

```{r gisLandscapePercent, echo=FALSE, cache=FALSE, eval=FALSE}
gisVarDF<-na.omit(hkm2014Data[,c(gisNames,lulcPercentNames,respName)])
gisPerc_varsel<-varSelRF(gisVarDF[,1:dim(gisVarDF)[2]-1],gisVarDF[,respName],ntree = 10000, 
												 ntreeIterat = 5000,vars.drop.frac = 0.2)
summary(gisPerc_varsel$selec.history)
plot(gisPerc_varsel, which=2)
```



